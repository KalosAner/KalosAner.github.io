---
layout:       post
title:        "FFmpeg命令行使用技巧"
author:       "kalos Aner"
header-style: text
catalog:      true
tags:
    - FFmpeg
    - 音视频
---

## FFmpeg命令行使用技巧

**音视频处理流程：**

```mermaid
graph LR
A[输入文件] --demuxer-->B[编码数据包] --decoder--> C[解码后数据帧] --filter--> D[处理后的数据帧] --encoder--> E[编码数据包] --muxer--> F[输出文件] 
```

**命令查询：**

| 命令参数   | 内容                                    | 命令参数     | 内容                   |
| ---------- | --------------------------------------- | ------------ | ---------------------- |
| -version   | 显示版本                                | -bsfs        | 显示可用比特流filter   |
| -buildconf | 显示编译配置                            | -protocols   | 显示可用的协议         |
| -formats   | 显示可用格式<br>(muxers+demuxers)       | -filters     | 显示可用的过滤器       |
| -muxers    | 显示可用复用器                          | -pix_fmts    | 显示可用的像素格式     |
| -demuxers  | 显示可用解复用器                        | -layouts     | 显示标准声道名称       |
| -codecs    | 显示可用编解码器<br>(decoders+encoders) | -sample_fmts | 显示可用的音频采样格式 |
| -decoders  | 显示可用解码器                          | -colors      | 显示可用的颜色名称     |
| -encoders  | 显示可用编码器                          |              |                        |

**参数介绍：**

主要参数：`-i`：设定输入流，`-f`：设定输出格式(format)，`-ss`：开始时间，`-t`：时长

音频参数：`-aframes`：设置要输出的音频帧数 ，`-b:a`：音频码率，`-ar`：设定采样率，`-ac`：设定声音的Channel数，`-acodec`设定声音编解码器，如果用copy表示原始编解码数据必须别拷贝，`-an`：不处理音频，`-af`：音频过滤器。

视频参数：`-vframes`：设置要输出的视频帧数，`-b`：设定视频码率，`-b:v`：视频码率，`-r`：设定帧速率，`-s`：设定画面的宽与高，`-vn`：不处理视频，`-aspect`设置纵横比4:3，`-vcodec`设定视频编解码器，如果用copy表示原始编解码数据必须被拷贝，`-vf`：视频过滤器。

**提取视频：**

保留编码格式：

```sh
ffmpeg -i test.mp4 -vcodec copy -an test_copy.h264
```

修改成指定格式：

```sh
ffmpeg -i test.mp4 -vcodec libx264 -an test.h264
```

**提取音频：**

保留编码格式：

```sh
ffmpeg -i test.mp4 -acodec copy -vn test.aac
```

修改成指定格式：

```sh
ffmpeg -i test.mp4 -acodec libmp3lame -vn test.mp3
```

**提取YUV（像素格式）：**

提取3秒视频，修改分辨率为320x240

```sh
ffmpeg -i test_1280x720.mp4 -t 3 -pix_fmt yuv420p -s 320x240 yuv420p_320x240.yuv
```

**提取RGB（像素格式）：**

提取3秒视频，修改分辨率为320x240

```sh
ffmpeg -i test.mp4 -t 3 -pix_fmt rgb24 -s 320x240 rgb24_320x240.rgb
```

**RGB和YUV之间的转换**

```sh
ffmpeg -s 320x240 -pix_fmt yuv420p -i yuv420p_320x240.yuv -pix_fmt rgb24
rgb24_320x240_2.rgb
```

**提取PCM：**

Pulse Code Modulation，脉冲编码调制

提出成pcm的文件可以不加pcm后缀。

-ar 采样率，-ac 通道数，-f 编码格式

```sh
ffmpeg -i buweishui.mp3 -ar 48000 -ac 2 -f s16le 48000_2_s16le.pcm
ffmpeg -i buweishui.mp3 -ar 48000 -ac 2 -sample_fmt s16 out_s16.wav
ffmpeg -i buweishui.mp3 -ar 48000 -ac 2 -codec:a pcm_s16le out2_s16le.wav
ffmpeg -i buweishui.mp3 -ar 48000 -ac 2 -f f32le 48000_2_f32le.pcm
ffmpeg -i test.mp4 -t 10 -vn -ar 48000 -ac 2 -f f32le 48000_2_f32le_2.pcm
```

**转封装命令：**

-r 修改帧率，-b:a 400k -b:v 192k 修改音视频码率，-s 修改视频分辨率，-ar 修改音频采样率

```sh
ffmpeg -i test.mp4 -vcodec copy -acodec copy test_copy.ts
ffmpeg -i test.mp4 -vcodec libx265 -acodec libmp3lame out_h265_mp3.mkv
ffmpeg -i test.mp4 -r 15 output2.mp4
ffmpeg -i test.mp4 -b 400k output_b.mkv
ffmpeg -i test.mp4 -b:v 400k output_bv.mkv
ffmpeg -i test.mp4 -b:a 192k output_ba.mp4
ffmpeg -i test.mp4 -b:v 400k -b:a 192k output_bva.mp4
ffmpeg -i test.mp4 -s 480x270 output_480x270.mp4
ffmpeg -i test.mp4 -ar 44100 output_44100hz.mp4
```

```sh
错误命令：修改帧率和修改视频码率会自动重新解码。
ffmpeg -i test.mp4 -r 15 -codec copy output.mp4
```

**视频截取：**

-ss 起始时间，-t 截取时长

```sh
ffmpeg -i 沙海02.mp4 -ss 00:05:00 -t 10 -codec copy 1.mp4
ffmpeg -i 复仇者联盟3.mp4 -ss 00:05:00 -t 10 -codec copy 2.mp4
ffmpeg -i 红海行动.mp4 -ss 00:05:00 -t 10 -codec copy 3.mp4
```

**转成ts格式：**

ts格式：每一片段都可以独立解码。

-vbsf 提高兼容性：分离某些封装格式中的H.264的时候，需要首先写入SPS和PPS，否则会导致分离出来的数据没有SPS、PPS而无法播放。H.264码流的SPS和PPS信息存储在AVCodecContext结构体的extradata中。需要使用ffmpeg中名称为“**h264_mp4toannexb**”的bitstream filter处理，一般该命令照抄即可。

```sh
ffmpeg -i 1.mp4 -codec copy -vbsf h264_mp4toannexb 1.ts
ffmpeg -i 2.mp4 -codec copy -vbsf h264_mp4toannexb 2.ts
ffmpeg -i 3.mp4 -codec copy -vbsf h264_mp4toannexb 3.ts
```

**转成flv格式：**

```sh
ffmpeg -i 1.mp4 -codec copy 1.flv
ffmpeg -i 2.mp4 -codec copy 2.flv
ffmpeg -i 3.mp4 -codec copy 3.flv
```

**视频拼接：**

```sh
以MP4格式进行拼接
方法1：ffmpeg -i "concat:1.mp4|2.mp4|3.mp4" -codec copy out_mp4.mp4  #可能无法正常播放
方法2：ffmpeg -f concat -i mp4list.txt -codec copy out_mp42.mp4
以TS格式进行拼接
方法1：ffmpeg -i "concat:1.ts|2.ts|3.ts" -codec copy out_ts.mp4 
方法2：ffmpeg -f concat -i tslist.txt -codec copy out_ts2.mp4
以FLV格式进行拼接
方法1：ffmpeg -i "concat:1.flv|2.flv|3.flv" -codec copy out_flv.mp4 #可能无法正常播放
方法2：ffmpeg -f concat -i flvlist.txt -codec copy out_flv2.mp4
```

mp4list.txt文件如下（其他格式同）：

```
file '1.mp4'
file '2.mp4'
file '3.mp4'
```

建议：

（1）每次都使用方法2进行拼接

<font color='red'>（2）转成TS格式再进行拼接</font>

注意：

（1）视频分辨率可以不同，但是编码格式必须统一

（2）音视频编码格式需要统一，音频参数（采样率/声道等）也需要统一

**截取图片：**

-y 覆盖，-f 格式，-s 宽高，-vframes 帧：如果大于1 那么 输出加**%03d** test%03d.jpg，image2 一种格式

```sh
ffmpeg -i test.mp4 -y -f image2 -ss 00:00:02 -vframes 1 -s 640x360 test.jpg
ffmpeg -i test.mp4 -y -f image2 -ss 00:00:02 -vframes 1 -s 640x360 test.bmp
```

逐帧转换

-r 设定帧速率

```sh
ffmpeg -i test.mp4 -t 5 -s 640x360 -r 15 frame%03d.jpg
```

图片转成视频

```sh
ffmpeg -f image2 -i frame%03d.jpg -r 25 video.mp4
```

**视频转GIF：**

```sh
ffmpeg -i test.mp4 -t 5 -r 1 image1.gif
ffmpeg -i test.mp4 -t 5 -r 25 -s 640x360 image2.gif
```

**GIF转视频：**